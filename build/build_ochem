#!/bin/bash

set -u
set -e

pwd=`pwd`
project="ochem";
project_dir="$pwd/release/tmp/ochem"
build_file=$pwd/projects/ochem/pom.xml
tag="qspr"
mkdir -p $project_dir

source commons
production_check

if $cleanup_before; then
	rm -rf $project_dir
	mkdir $project_dir
fi

   mkdir -p $project_dir/release
   cd $pwd
   cp -a workspace/git/. $project_dir/

   rm -rf `find $project_dir -iname .svn`
   
   project_dir=$project_dir/
   cd $project_dir
   git log -1 > $project_dir/ochem-webapp/src/main/webapp/version.info
   cd $pwd

   date +%Y-%m-%d\ %H:%M:%S >> $project_dir/ochem-webapp/src/main/webapp/version.info
   echo `env | grep SSH_CONNECTION  | awk -F ' ' {'print $1'} | awk -F '=' {'print $2'}` >> $project_dir/ochem-webapp/src/main/webapp/version.info

   HelperScripts/sources_batch $project_dir $tag
   
   if [ ! -z "$release_id" ]; then
   	 echo "$release_id" > $project_dir/ochem-webapp/src/main/webapp/release.info
   fi
   
   if [ -f $pwd/custom/ochem_prebuild ]; then
 		export project_dir="$project_dir"
 		cd $pwd/custom/
   		./ochem_prebuild
   		cd $pwd
   fi

    local_install_component $project_dir/autogenerated
    local_install_component $project_dir/parent-project
    local_install_component $project_dir/ochem-utils
    local_install_component $project_dir/metaserver-api
    local_install_component $project_dir/ochem-commons
    local_install_component $project_dir/ws-client

    echo "Packaging ochem..."
    cd $project_dir
    cp $build_file .
    mvn clean package
    echo "Done."

    maven_war=$project_dir/ochem-webapp/target/ochem-webapp-2.0-SNAPSHOT.war
    cp $maven_war $pwd/release/ochem.war

    if $cleanup_after ; then
    	rm -rf $project_dir
    fi
